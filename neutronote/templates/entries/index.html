{% extends "base.html" %}

{% block title %}Notebook ‚Äì neutroNote{% endblock %}

{% block content %}
<!-- IPTS Setup Modal -->
<div class="setup-overlay" id="setup-overlay" {% if config.is_configured %}style="display: none;"{% endif %}>
    <div class="setup-modal">
        <div class="setup-header">
            <h2>üìì Configure Notebook</h2>
            {% if config.is_configured %}
            <button type="button" class="btn-close" onclick="document.getElementById('setup-overlay').style.display='none'">√ó</button>
            {% endif %}
        </div>
        <p>Enter the IPTS number for this experiment notebook. This will be used for all run header lookups.</p>
        
        <form action="{{ url_for('entries.setup_notebook') }}" method="post">
            <div class="form-group">
                <label for="setup-ipts">IPTS Number <span class="required">*</span></label>
                <input type="text" id="setup-ipts" name="ipts" placeholder="e.g., IPTS-12345 or 12345" value="{{ config.ipts or '' }}" required {% if not config.is_configured %}autofocus{% endif %}>
                <small class="form-hint">Enter with or without "IPTS-" prefix.</small>
            </div>
            <div class="form-group">
                <label for="setup-title">Notebook Title (optional)</label>
                <input type="text" id="setup-title" name="notebook_title" placeholder="e.g., Diamond Anvil Calibration" value="{{ config.title or '' }}">
            </div>
            <button type="submit" class="btn btn-primary btn-large">{% if config.is_configured %}Update{% else %}Start Notebook{% endif %}</button>
        </form>
    </div>
</div>

<div class="split-view">
    <!-- LEFT PANEL: Entry Creation -->
    <aside class="create-panel">
        <h2>Create Entry</h2>
        
        <!-- Flash messages (errors, etc.) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            {{ message }}
                            <button type="button" class="flash-close" onclick="this.parentElement.remove()">√ó</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <!-- Entry type tabs -->
        <div class="entry-type-tabs">
            <button class="tab active" data-type="text">Text</button>
            <button class="tab" data-type="header" {% if not config.is_configured %}disabled title="Configure IPTS first"{% endif %}>Header</button>
            <button class="tab" data-type="image">Image</button>
            <button class="tab" data-type="data" {% if not config.is_configured %}disabled title="Configure IPTS first"{% endif %}>Data</button>
            <button class="tab" data-type="code" disabled title="Coming soon">Code</button>
        </div>

        <!-- Text entry form -->
        <form id="text-form" class="entry-form active" action="{{ url_for('entries.create_text') }}" method="post">
            <div class="form-group">
                <label for="title">Title (optional)</label>
                <input type="text" id="title" name="title" placeholder="Entry title...">
            </div>
            <div class="form-group">
                <label for="body">Content</label>
                <textarea id="body" name="body" rows="8" placeholder="Write your notes here... (Markdown supported, use $...$ for inline math)" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Entry</button>
        </form>

        <!-- Run Header entry form -->
        <form id="header-form" class="entry-form" action="{{ url_for('entries.create_header') }}" method="post">
            {% if config.is_configured %}
            <div class="form-group">
                <label for="run_number">Run Number</label>
                <input type="number" id="run_number" name="run_number" placeholder="e.g., 67890" required min="1">
                <small class="form-hint">Fetch run metadata from {{ config.ipts }}</small>
            </div>
            <button type="submit" class="btn btn-primary">Fetch Run Header</button>
            {% else %}
            <p class="placeholder-text">Please configure the notebook IPTS first.</p>
            {% endif %}
        </form>

        <!-- Image upload form -->
        <form id="image-form" class="entry-form" action="{{ url_for('entries.create_image') }}" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="image">Select Image</label>
                <input type="file" id="image" name="image" accept="image/*" required>
                <small class="form-hint">Supported formats: PNG, JPG, GIF, WebP, SVG (max 16 MB)</small>
            </div>
            <div class="form-group">
                <label for="caption">Caption (optional)</label>
                <input type="text" id="caption" name="caption" placeholder="Image caption...">
            </div>
            <button type="submit" class="btn btn-primary">Upload Image</button>
        </form>

        <!-- Reduced Data entry form -->
        <form id="data-form" class="entry-form">
            {% if config.is_configured %}
            <div class="form-group">
                <label for="state-select">Instrument State</label>
                <select id="state-select" name="state_id" required>
                    <option value="">Loading states...</option>
                </select>
                <small class="form-hint">Select the instrument configuration state</small>
            </div>
            
            <div id="selected-run-info" class="selected-run-info" style="display: none;">
                <div class="selected-run-header">
                    <strong>Selected Run</strong>
                    <button type="button" class="btn-clear-selection" onclick="clearRunSelection()">‚úï</button>
                </div>
                <div class="selected-run-details">
                    <span class="selected-run-number" id="selected-run-number"></span>
                    <span class="selected-run-title" id="selected-run-title"></span>
                </div>
                <div class="selected-run-meta">
                    <span id="selected-run-duration"></span> ¬∑ <span id="selected-run-timestamp"></span>
                </div>
            </div>
            
            <button type="button" class="btn btn-secondary" id="browse-runs-btn" onclick="openRunBrowser()">
                üìÇ Browse Reduced Runs
            </button>
            
            <input type="hidden" id="selected-run" name="run_number" value="">
            <input type="hidden" id="selected-state" name="state_id" value="">
            
            <button type="submit" class="btn btn-primary" id="data-submit-btn" disabled>
                View Reduced Data
            </button>
            {% else %}
            <p class="placeholder-text">Please configure the notebook IPTS first.</p>
            {% endif %}
        </form>
        
        <form id="code-form" class="entry-form" style="display:none;">
            <p class="placeholder-text">Code entry form coming in Phase 4...</p>
        </form>
    </aside>

<!-- Run Browser Modal -->
<div id="run-browser-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>üìÇ Browse Reduced Runs</h3>
            <button type="button" class="btn-close" onclick="closeRunBrowser()">√ó</button>
        </div>
        
        <div class="modal-filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filter-search">Search Title</label>
                    <input type="text" id="filter-search" placeholder="Filter by title...">
                </div>
                <div class="filter-group">
                    <label for="filter-duration">Min Duration</label>
                    <select id="filter-duration">
                        <option value="0">All runs</option>
                        <option value="60">‚â• 1 minute</option>
                        <option value="300">‚â• 5 minutes</option>
                        <option value="600">‚â• 10 minutes</option>
                        <option value="1800">‚â• 30 minutes</option>
                        <option value="3600">‚â• 1 hour</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-run">Run Number</label>
                    <input type="text" id="filter-run" placeholder="e.g., 65890">
                </div>
            </div>
            <div class="filter-summary">
                Showing <span id="filter-count">0</span> of <span id="total-count">0</span> runs
            </div>
        </div>
        
        <div class="modal-body">
            <table class="run-table" id="run-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="run_number">Run # <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="title">Title <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="duration">Duration <span class="sort-indicator"></span></th>
                        <th class="sortable" data-sort="start_time">Start Time <span class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody id="run-table-body">
                    <tr><td colspan="4" class="loading-row">Loading runs...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRunBrowser()">Cancel</button>
            <button type="button" class="btn btn-primary" id="select-run-btn" disabled onclick="confirmRunSelection()">
                Select Run
            </button>
        </div>
    </div>
</div>

    <!-- RIGHT PANEL: Timeline -->
    <section class="timeline-panel">
        <!-- Notebook IPTS banner -->
        {% if config.is_configured %}
        <div class="notebook-info">
            <span class="ipts-badge">{{ config.ipts }}</span>
            {% if config.title %}
            <span class="notebook-title">{{ config.title }}</span>
            {% endif %}
            <button type="button" class="btn-settings" onclick="document.getElementById('setup-overlay').style.display='flex'" title="Change IPTS">‚öôÔ∏è</button>
        </div>
        {% endif %}
        
        <h2>Timeline</h2>
        
        <div class="timeline" id="timeline">
            {% if entries %}
                {% for entry in entries %}
                    {% include "entries/_entry_card.html" %}
                {% endfor %}
            {% else %}
                <p class="empty-state">No entries yet. Create your first entry on the left!</p>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// Function to switch to a specific tab
function switchToTab(type) {
    const tab = document.querySelector(`.tab[data-type="${type}"]`);
    if (!tab || tab.disabled) return;
    
    // Update active tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    // Hide all forms, show the selected one
    document.querySelectorAll('.entry-form').forEach(f => {
        f.style.display = 'none';
        f.classList.remove('active');
    });
    const form = document.getElementById(type + '-form');
    form.style.display = 'block';
    form.classList.add('active');
    
    // Load states when switching to data tab (use direct DOM lookup since stateSelect may not be defined yet)
    if (type === 'data') {
        const stateSelectEl = document.getElementById('state-select');
        if (stateSelectEl && stateSelectEl.options.length <= 1 && typeof loadStates === 'function') {
            loadStates();
        }
    }
}

// Tab switching for entry types
document.querySelectorAll('.entry-type-tabs .tab').forEach(tab => {
    tab.addEventListener('click', function() {
        if (this.disabled) return;
        switchToTab(this.dataset.type);
    });
});

// Check for tab parameter in URL (to stay on tab after error)
const urlParams = new URLSearchParams(window.location.search);
const tabParam = urlParams.get('tab');
if (tabParam) {
    switchToTab(tabParam);
}

// Auto-scroll timeline to bottom (newest entries)
const timeline = document.getElementById('timeline');
timeline.scrollTop = timeline.scrollHeight;

// =============================================================================
// Reduced Data Selection Logic
// =============================================================================

const stateSelect = document.getElementById('state-select');
const selectedRunInfo = document.getElementById('selected-run-info');
const selectedRunNumber = document.getElementById('selected-run-number');
const selectedRunTimestamp = document.getElementById('selected-run-timestamp');
const selectedRunInput = document.getElementById('selected-run');
const selectedStateInput = document.getElementById('selected-state');
const dataSubmitBtn = document.getElementById('data-submit-btn');

let allRuns = [];  // Cache of runs for current state
let selectedRun = null;

// Load states when data tab is clicked
function loadStates() {
    if (!stateSelect) return;
    
    stateSelect.innerHTML = '<option value="">Loading...</option>';
    
    fetch('/entries/api/states')
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                stateSelect.innerHTML = `<option value="">Error: ${data.error}</option>`;
                return;
            }
            
            if (!data.states || data.states.length === 0) {
                stateSelect.innerHTML = '<option value="">No reduced data found</option>';
                return;
            }
            
            stateSelect.innerHTML = '<option value="">Select a state...</option>';
            data.states.forEach(stateId => {
                const opt = document.createElement('option');
                opt.value = stateId;
                // Show abbreviated state ID for display
                opt.textContent = `State: ${stateId.substring(0, 8)}...`;
                stateSelect.appendChild(opt);
            });
            
            // Auto-select if only one state
            if (data.states.length === 1) {
                stateSelect.value = data.states[0];
                selectedStateInput.value = data.states[0];
            }
        })
        .catch(err => {
            console.error('Failed to load states:', err);
            stateSelect.innerHTML = '<option value="">Failed to load states</option>';
        });
}

// State selection change - just update the hidden input, runs are loaded in modal
if (stateSelect) {
    stateSelect.addEventListener('change', function() {
        selectedRun = null;
        selectedRunInfo.style.display = 'none';
        dataSubmitBtn.disabled = true;
        selectedRunInput.value = '';
        selectedStateInput.value = this.value;
        allRuns = [];  // Clear cached runs so modal reloads them
    });
}

// Load states when switching to data tab
document.querySelector('.tab[data-type="data"]')?.addEventListener('click', function() {
    if (!this.disabled && stateSelect && stateSelect.options.length <= 1) {
        loadStates();
    }
});

// Load states on initial page load if data tab is active
const dataTab = document.querySelector('.tab[data-type="data"]');
if (dataTab && dataTab.classList.contains('active') && stateSelect && stateSelect.options.length <= 1) {
    loadStates();
}

// =============================================================================
// Run Browser Modal Logic
// =============================================================================

const runBrowserModal = document.getElementById('run-browser-modal');
const runTableBody = document.getElementById('run-table-body');
const filterSearch = document.getElementById('filter-search');
const filterDuration = document.getElementById('filter-duration');
const filterRun = document.getElementById('filter-run');
const filterCount = document.getElementById('filter-count');
const totalCount = document.getElementById('total-count');
const selectRunBtn = document.getElementById('select-run-btn');

let browserRuns = [];  // All runs loaded in the browser
let filteredRuns = [];  // Current filtered view
let browserSelectedRun = null;  // Currently selected run in modal
let sortColumn = 'run_number';
let sortDirection = 'asc';

// Open the run browser modal
function openRunBrowser() {
    if (!stateSelect || !stateSelect.value) {
        alert('Please select an instrument state first');
        return;
    }
    
    runBrowserModal.style.display = 'flex';
    browserSelectedRun = null;
    selectRunBtn.disabled = true;
    
    // Reset filters
    filterSearch.value = '';
    filterDuration.value = '0';
    filterRun.value = '';
    
    // Load runs if not already loaded
    if (allRuns.length > 0) {
        browserRuns = allRuns;
        applyFiltersAndSort();
    } else {
        loadRunsForBrowser();
    }
}

// Close the run browser modal
function closeRunBrowser() {
    runBrowserModal.style.display = 'none';
}

// Load runs specifically for the browser
function loadRunsForBrowser() {
    const stateId = stateSelect.value;
    runTableBody.innerHTML = '<tr><td colspan="4" class="loading-row">Loading runs...</td></tr>';
    
    fetch(`/entries/api/states/${stateId}/runs`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                runTableBody.innerHTML = `<tr><td colspan="4" class="loading-row">Error: ${data.error}</td></tr>`;
                return;
            }
            browserRuns = data.runs;
            allRuns = data.runs;  // Update the cache
            applyFiltersAndSort();
        })
        .catch(err => {
            runTableBody.innerHTML = '<tr><td colspan="4" class="loading-row">Failed to load runs</td></tr>';
            console.error('Failed to load runs:', err);
        });
}

// Apply current filters and sorting
function applyFiltersAndSort() {
    const searchQuery = filterSearch.value.toLowerCase().trim();
    const minDuration = parseInt(filterDuration.value) || 0;
    const runQuery = filterRun.value.trim();
    
    // Filter
    filteredRuns = browserRuns.filter(run => {
        // Title search
        if (searchQuery && !(run.title || '').toLowerCase().includes(searchQuery)) {
            return false;
        }
        // Duration filter
        if (minDuration > 0 && (run.duration || 0) < minDuration) {
            return false;
        }
        // Run number filter
        if (runQuery && !String(run.run_number).includes(runQuery)) {
            return false;
        }
        return true;
    });
    
    // Sort
    filteredRuns.sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];
        
        // Handle null/undefined
        if (aVal == null) aVal = sortColumn === 'title' ? '' : 0;
        if (bVal == null) bVal = sortColumn === 'title' ? '' : 0;
        
        // String comparison for title
        if (sortColumn === 'title') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }
        
        let cmp = 0;
        if (aVal < bVal) cmp = -1;
        else if (aVal > bVal) cmp = 1;
        
        return sortDirection === 'asc' ? cmp : -cmp;
    });
    
    // Update counts
    totalCount.textContent = browserRuns.length;
    filterCount.textContent = filteredRuns.length;
    
    // Render table
    renderRunTable();
}

// Render the run table
function renderRunTable() {
    if (filteredRuns.length === 0) {
        runTableBody.innerHTML = '<tr><td colspan="4" class="loading-row">No runs match the current filters</td></tr>';
        return;
    }
    
    runTableBody.innerHTML = '';
    filteredRuns.forEach(run => {
        const row = document.createElement('tr');
        row.className = 'run-row';
        if (browserSelectedRun && browserSelectedRun.run_number === run.run_number) {
            row.classList.add('selected');
        }
        row.innerHTML = `
            <td class="run-number-cell">${run.run_number}</td>
            <td class="title-cell" title="${escapeHtml(run.title || 'No title')}">${escapeHtml(run.title || '‚Äî')}</td>
            <td class="duration-cell">${run.duration_display || '‚Äî'}</td>
            <td class="timestamp-cell">${run.start_time_display || run.timestamp_display || '‚Äî'}</td>
        `;
        row.addEventListener('click', () => selectRunInBrowser(run, row));
        runTableBody.appendChild(row);
    });
    
    // Update sort indicators
    document.querySelectorAll('.run-table th').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === sortColumn) {
            th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });
}

// Select a run in the browser
function selectRunInBrowser(run, row) {
    // Clear previous selection
    document.querySelectorAll('.run-row.selected').forEach(r => r.classList.remove('selected'));
    
    // Mark new selection
    row.classList.add('selected');
    browserSelectedRun = run;
    selectRunBtn.disabled = false;
}

// Confirm run selection from browser
function confirmRunSelection() {
    if (!browserSelectedRun) return;
    
    selectedRun = browserSelectedRun;
    selectedRunInput.value = browserSelectedRun.run_number;
    
    // Update selection display
    selectedRunNumber.textContent = browserSelectedRun.run_number;
    document.getElementById('selected-run-title').textContent = browserSelectedRun.title || '‚Äî';
    document.getElementById('selected-run-duration').textContent = browserSelectedRun.duration_display || '‚Äî';
    document.getElementById('selected-run-timestamp').textContent = browserSelectedRun.start_time_display || browserSelectedRun.timestamp_display || '‚Äî';
    selectedRunInfo.style.display = 'block';
    
    // Enable submit button
    dataSubmitBtn.disabled = false;
    
    closeRunBrowser();
}

// Clear run selection
function clearRunSelection() {
    selectedRun = null;
    browserSelectedRun = null;
    selectedRunInput.value = '';
    selectedRunInfo.style.display = 'none';
    dataSubmitBtn.disabled = true;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Set up filter event listeners
if (filterSearch) filterSearch.addEventListener('input', applyFiltersAndSort);
if (filterDuration) filterDuration.addEventListener('change', applyFiltersAndSort);
if (filterRun) filterRun.addEventListener('input', applyFiltersAndSort);

// Set up sort click handlers
document.querySelectorAll('.run-table th.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const newSort = this.dataset.sort;
        if (newSort === sortColumn) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = newSort;
            sortDirection = 'asc';
        }
        applyFiltersAndSort();
    });
});

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && runBrowserModal.style.display === 'flex') {
        closeRunBrowser();
    }
});

// Close modal on backdrop click
runBrowserModal?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeRunBrowser();
    }
});
</script>
{% endblock %}
